# Types

typedef struct pch_schib pch_schib_t;

typedef struct pch_pmcw pch_pmcw_t;

typedef struct pch_intcode pch_intcode_t;

typedef void(*io_callback_t)(pch_intcode_t, pch_scsw_t);

# Compile-time constants and definitions - examples:

#define PCH_NUM_CSS_CUS 4
#define PCH_NUM_SCHIBS 40

## Debugging assertions:

#define PARAM_ASSERTIONS_ENABLED_PCH_CSS 1
#define PARAM_ASSERTIONS_ENABLED_PCH_TXSM 1

# API

## Initialisation

### Initialisation of whole CSS

void pch_css_init(void);

bool pch_css_set_trace(bool trace);

void pch_css_start(uint8_t dmairqix);

irq_set_exclusive_handler(schib_func_irqnum, pch_css_schib_func_irq_handler);
irq_set_enabled(schib_func_irqnum, true);
void pch_css_set_func_irq(irq_num_t irqnum);

void pch_css_set_io_irq(irq_num_t irqnum);

io_callback_t pch_css_set_io_callback(io_callback_t io_callback);

irq_set_exclusive_handler(io_irqnum, pch_css_io_irq_handler);
irq_set_enabled(io_irqnum, true);

void pch_css_set_isc_enable_mask(uint8_t mask);

### Initialisation of each channel to a CU

void pch_css_cu_claim(pch_cunum_t cunum, uint16_t num_devices);

#### Initialise a channel to a UART CU

void pch_css_uartcu_configure(pch_cunum_t cunum, uart_inst_t *uart, dma_channel_config ctrl);

#### Initialise a channel to a memchan (cross-core) CU

void pch_memchan_init();

dmachan_tx_channel_t *pch_cus_cu_get_tx_channel(pch_cunum_t cunum);

void pch_css_memcu_configure(pch_cunum_t cunum, pch_dmaid_t txdmaid, pch_dmaid_t rxdmaid, dmachan_tx_channel_t *txpeer);

#### Start a channel to a CU

bool pch_css_set_trace_cu(pch_cunum_t cunum, bool trace);

void pch_css_cu_start(pch_cunum_t cunum);

### Set PMCW flags of a subchannel to enable/disable, trace or change ISC

int pch_sch_modify_flags(pch_sid_t sid, uint16_t flags);

## Start, monitor and control channel programs for a subchannel

int pch_sch_start(pch_sid_t sid, pch_ccw_t *ccw_addr);
int pch_sch_resume(pch_sid_t sid);
int pch_sch_test(pch_sid_t sid, pch_scsw_t *scsw);
int pch_sch_modify(pch_sid_t sid, pch_pmcw_t *pmcw);
int pch_sch_store(pch_sid_t sid, pch_schib_t *out_schib);
// int pch_sch_cancel(pch_sid_t sid);
pch_intcode_t pch_test_pending_interruption(void);

### Variations and wrappers for convenience or optimisation

int pch_sch_wait(pch_sid_t sid, pch_scsw_t *scsw);
int pch_sch_wait_timeout(pch_sid_t sid, pch_scsw_t *scsw, absolute_time_t timeout_timestamp);
int pch_sch_run_wait(pch_sid_t sid, pch_ccw_t *ccw_addr, pch_scsw_t *scsw);
int pch_sch_run_wait_timeout(pch_sid_t sid, pch_ccw_t *ccw_addr, pch_scsw_t *scsw, absolute_time_t timeout_timestamp);

int pch_sch_store_pmcw(pch_sid_t sid, pch_pmcw_t *out_pmcw);
int pch_sch_store_scsw(pch_sid_t sid, pch_scsw_t *out_scsw);

int pch_sch_modify_intparm(pch_sid_t sid, uint32_t intparm);
int pch_sch_modify_flags(pch_sid_t sid, uint16_t flags);
int pch_sch_modify_isc(pch_sid_t sid, uint8_t isc);
int pch_sch_modify_enabled(pch_sid_t sid, bool enabled);
int pch_sch_modify_traced(pch_sid_t sid, bool traced);
