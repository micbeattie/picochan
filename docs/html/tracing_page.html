<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Picochan: Tracing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Picochan<span id="projectnumber">&#160;0.1</span>
   </div>
   <div id="projectbrief">Picochan documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('tracing_page.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Tracing </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_docs_2tracing"></a></p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md37"></a>
Introduction</h2>
<ul>
<li>Optional tracing to help debugging of CSS, CU and their users</li>
<li>Code only present when compile-time <span class="tt">PCH_CONFIG_ENABLE_TRACE</span> <span class="tt">#define</span>d as non-zero</li>
<li>Trace records are written for various events in CSS and CU when appropriate trace flags are set</li>
<li>Trace records are small (~8-28 bytes) binary structs written to a small set of statically allocated buffers (a <span class="tt">bufferset</span>) that is treated as a ring buffer</li>
<li>A bufferset is compile-time defined for one or both of CSS (if used) and CUs (if used) as, by default, 2 x 1KB buffers. Offloading traces for processing (see below) if the buffers are consecutive in memory (e.g. a single 2KB chunk).</li>
<li>Trace records consist of a 48-bit timestamp (microseconds since boot), an 8-bit "trace record type" and an 8-bit count of associated data</li>
<li>When each individual trace buffer becomes full, an IRQ can optionally be raised so that the application can fetch and offload that buffer's data before the other buffer(s) in the bufferset fill and the ring returns to restart writing to the just-filled buffer.</li>
<li>The resulting data in the bufferset is expected to be offloaded and processed off-platform</li>
<li>Offloading the necessary data can be done simply by using openocd or gdb (when SWD access is available) to fetch<ul>
<li>the 32-byte metadata global variables <span class="tt">CSS.trace_bs</span> (CSS) or <span class="tt">pch_cus_trace_bs</span> (for CU)</li>
<li>the trace buffers themselves</li>
</ul>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
<span class="tt">pch_dump_trace</span> - parse and display traces (off-platform)</h2>
<p>A <span class="tt">pch_dump_trace</span> program is provided - C source in the <span class="tt">tools/pch_dump_trace.c</span> directory of the Picochan repository - which is expected to be (compiled and) run off-platform rather than on the Pico itself.</p>
<p><span class="tt">pch_dump_trace</span> takes two filenames as input which are expected to contain</p><ul>
<li>the raw data from the 32-byte bufferset structure</li>
<li>the concetenated raw data from the trace buffers. This can simply be the contents of a single global <span class="tt">unsigned char pch_css_trace_buffer_space[]</span> array if there is room to have the buffers contigous (e.g. as 2KB instead of separate 1KB and 1KB)</li>
</ul>
<p><span class="tt">pch_dump_trace</span> parses the binary trace record data and, by default, extracts the trace record fields and explains them in human-readable output (although an option for raw "dump the timestamps, record type
name/numbers and data in hex format" is available). For example, an extract from a basic test (with the UART channel intentionally slowed to 1200 baud), reformatted slightly (to combine the separate CSS and CU traces with indicators "+" for CSS-side and "-" for CU-side):</p>
<div class="fragment"><div class="line">01:02.707412 +CSS Function IRQ raised for CU=0 with pending UA=4 while tx_active=0</div>
<div class="line">01:02.707441 +CSS CCW fetch for SID:0004 CCW address=20003000 provides CCW{cmd:03 flags:40 count=4 addr:20003300}</div>
<div class="line">01:02.707474 +CSS-side SID:0004 sends packet{Start ua=4 CCWcmd:03 count=0(exact)}</div>
<div class="line">01:02.707491 +CU tx channel DMAid=0 sets source to cmdbuf</div>
<div class="line">01:02.707522 +IRQ for CSS-side CU=0 with DMA_IRQ_0 tx:irq_state=raised+complete,mem_src_state=idle rx:irq_state=none,mem_dst_state=idle</div>
<div class="line">01:02.707537 +CSS-side CU=0 handling tx complete while txsm is idle</div>
<div class="line">01:02.707565 +start subchannel SID:0004 CCW address=20003000 cc=0</div>
<div class="line">01:02.707580 +test subchannel SID:0004 cc=1</div>
<div class="line">01:02.707587 +test subchannel SID:0004 cc=1</div>
<div class="line">01:02.743898 -IRQ for dev-side CU=0 with DMA_IRQ_1 tx:irq_state=none,mem_src_state=idle rx:irq_state=raised+complete,mem_dst_state=idle</div>
<div class="line">01:02.743922 -dev-side CU=0 UA=4 received packet{Start ua=4 CCWcmd:03 count=0(exact)}</div>
<div class="line">01:02.743953 -CU rx channel DMAid=3 sets destination to cmdbuf</div>
<div class="line">01:02.743963 -dev-side CU=0 calls callback 1 for UA=4</div>
<div class="line">01:02.744007 -dev-side CU=0 UA=4 sends packet{RequestRead ua=4 count=4}</div>
<div class="line">01:02.744017 -CU tx channel DMAid=2 sets source to cmdbuf</div>
<div class="line">01:02.744030 -IRQ for dev-side CU=0 with DMA_IRQ_1 tx:irq_state=raised+complete,mem_src_state=idle rx:irq_state=none,mem_dst_state=idle</div>
<div class="line">01:02.744040 -dev-side CU=0 handling tx complete while txsm is idle</div>
<div class="line">01:02.780445 +IRQ for CSS-side CU=0 with DMA_IRQ_0 tx:irq_state=none,mem_src_state=idle rx:irq_state=raised+complete,mem_dst_state=idle</div>
<div class="line">01:02.780460 +CSS-side SID:0004 received packet{RequestRead ua=4 count=4}</div>
<div class="line">01:02.780478 +CSS-side SID:0004 sends packet{Data|End ua=4 count=4}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md39"></a>
Interactive "offload trace buffers and parse/display" with gdb</h2>
<p>For gdb, an example when the buffers are defined as a single contiguous array:</p>
<div class="fragment"><div class="line">unsigned char pch_css_trace_buffer_space[PCH_TRC_NUM_BUFFERS * PCH_TRC_BUFFER_SIZE] __aligned(4);</div>
</div><!-- fragment --><p> the following gdb definitions fetch and dump the current trace buffers to host-local files and run the <span class="tt">pch_dump_trace</span> program on the results (see below) to parse and display human-readable explanations of the traced events:</p>
<div class="fragment"><div class="line">define pch-show-css-trace</div>
<div class="line">  dump binary value /tmp/gdb-css.bs CSS.trace_bs</div>
<div class="line">  dump binary value /tmp/gdb-css.bufs pch_css_trace_buffer_space</div>
<div class="line">  shell pch_dump_trace /tmp/gdb-css.bs /tmp/gdb-css.bufs</div>
<div class="line">end</div>
<div class="line">document pch-show-css-trace</div>
<div class="line">  Dumps CSS trace buffers and uses pch_dump_trace to show them</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">define pch-show-cus-trace</div>
<div class="line">  dump binary value /tmp/gdb-cus.bs pch_cus_trace_bs</div>
<div class="line">  dump binary value /tmp/gdb-cus.bufs pch_cus_trace_buffer_space</div>
<div class="line">  shell pch_dump_trace /tmp/gdb-cus.bs /tmp/gdb-cus.bufs</div>
<div class="line">end</div>
<div class="line">document pch-show-cus-trace</div>
<div class="line">  Dumps CU trace buffers and uses pch_dump_trace to show them</div>
<div class="line">end</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md40"></a>
API to enable/disable trace at various levels</h2>
<ul>
<li>The compile-time default is that no tracing code is present at all</li>
<li>To include the ability to enable tracing,</li>
</ul>
<div class="fragment"><div class="line">#define PCH_CONFIG_ENABLE_TRACE 1</div>
</div><!-- fragment --><ul>
<li>To change the default of 2 x 1KB buffers in each bufferset (where CSS, if present, uses one bufferset and CUs, if present, use one bufferset between them), define <span class="tt">PCH_TRC_NUM_BUFFERS</span> (default 2) and/or <span class="tt">PCH_TRC_BUFFER_SIZE</span> (default 1024) to different compile-time constants, e.g.</li>
</ul>
<div class="fragment"><div class="line">#define PCH_TRC_NUM_BUFFERS 3</div>
<div class="line">#define PCH_TRC_BUFFER_SIZE 2048</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md41"></a>
Tracing for CSS</h3>
<ul>
<li>No trace records are written at all unless/until <span class="tt">pch_css_set_trace(true)</span> is called, typically done immediately after <span class="tt"><a class="el" href="group__picochan__css.html#ga73efa9ddbc2d32f8df54eb2317c7043c" title="Initialise CSS.">pch_css_init()</a></span>. With this enabled, trace records for CSS-global events are written.</li>
<li>To enable trace records related to a given channel to be written, call <span class="tt">pch_chp_set_trace(chpid, true)</span>. If the trace flag is not set for a channel then no trace records for any subchannel on that channel are written. With the trace flag for a channel enabled, non-subchannel-specific trace records related to the channel are written.</li>
<li>To enable trace records related to a given subchannel, set the <span class="tt">PCH_PMCW_TRACED</span> flag bit in the subchannel's <span class="tt">PMCW</span>, e.g. to set the trace flag at the same time as subchannel <span class="tt">sid</span> is enabled:</li>
</ul>
<div class="fragment"><div class="line">uint16_t flags = PCH_PMCW_ENABLED | PCH_PMCW_TRACED;</div>
<div class="line">pch_sch_modify_flags(sid, flags);</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md42"></a>
Tracing for CU</h3>
<ul>
<li>No trace records are written at all unless/until <span class="tt">pch_cus_set_trace(true)</span> is called, typically done immediately after <span class="tt"><a class="el" href="group__picochan__cu.html#ga176071963f4c0ee29dd30a34a2241edc" title="Initialise CU subsystem.">pch_cus_init()</a></span>.</li>
<li>To enable trace records related to a given CU and all its devices to be written, call <span class="tt">pch_cus_trace_cu(cua, true)</span>. Unlike for the CSS API, setting the trace flag at CU level enables trace records for all its devices.</li>
<li>To enable trace records related to a given device, set the <span class="tt">PCH_DEVIB_FLAG_TRACED</span> flag bit in the <span class="tt">devib</span>, e.g. with <span class="tt">pch_devib_set_traced(devib, true)</span>. With the <span class="tt">PCH_DEVIB_FLAG_TRACED</span> bit present in the <span class="tt">flags</span> field of a <span class="tt">devib</span> and the CU-global trace flag set (with <span class="tt"><a class="el" href="group__picochan__cu.html#gaeb9637f1048f58dc46456ed333f08dc2" title="Sets whether CU subsystem tracing is enabled.">pch_cus_set_trace()</a></span>), records will be written for events related to the device regardless of whether the trace flag for its CU has been set with <span class="tt">pch_cus_trace_cu(cua, val)</span>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
